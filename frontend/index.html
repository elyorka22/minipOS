<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <meta name="api-url" content="%VITE_API_URL%">
  <title>–£—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</title>
  <link rel="manifest" href="/manifest.json">
  <script>
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API URL –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–ª—è Vercel)
    window.API_URL = '%VITE_API_URL%' || 'http://localhost:3000';
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 10px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
    }
    
    .header h1 {
      font-size: 24px;
      color: #333;
    }
    
    .btn {
      width: 100%;
      padding: 25px;
      margin-bottom: 15px;
      font-size: 22px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      transition: background 0.3s;
    }
    
    .btn:active {
      background: #45a049;
    }
    
    .btn-secondary {
      background: #2196F3;
    }
    
    .btn-secondary:active {
      background: #0b7dda;
    }
    
    .btn-list {
      background: #FF9800;
    }
    
    .btn-list:active {
      background: #e68900;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      min-height: 300px;
      height: 300px;
    }
    
    .scanner-container video {
      width: 100% !important;
      height: 100% !important;
      min-height: 300px !important;
      object-fit: cover;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      background: #000;
      z-index: 2 !important;
      border-radius: 10px;
      position: relative !important;
    }
    
    #scanner, #receiveScanner, #barcodeScanner {
      width: 100% !important;
      height: 100% !important;
      min-height: 300px !important;
      border-radius: 10px;
      background: #000;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      object-fit: cover !important;
      z-index: 2 !important;
      position: relative !important;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 200px;
      border: 3px solid #4CAF50;
      border-radius: 10px;
      pointer-events: none;
      z-index: 10;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
      /* –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ overlay –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ */
      mix-blend-mode: normal;
    }
    
    /* –ü–∞–Ω–µ–ª—å –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ */
    #debugLogs {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      max-height: 200px;
      background: rgba(0, 0, 0, 0.9);
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      padding: 10px;
      border-radius: 5px;
      overflow-y: auto;
      z-index: 10000;
      display: none;
      border: 2px solid #0f0;
    }
    
    #debugLogs.show {
      display: block;
    }
    
    #debugLogs .log-entry {
      margin: 2px 0;
      word-break: break-all;
    }
    
    #debugLogs .log-error {
      color: #f00;
    }
    
    #debugLogs .log-success {
      color: #0f0;
    }
    
    #debugLogs .log-warning {
      color: #ff0;
    }
    
    #debugLogs .log-info {
      color: #0ff;
    }
    
    #toggleLogs {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50px;
      cursor: pointer;
      z-index: 10001;
      font-size: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    #copyLogs {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 11px;
      z-index: 10002;
    }
    
    #copyLogs:hover {
      background: #1976D2;
    }
    
    #copyLogs:active {
      background: #0D47A1;
    }
    
    .message {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }
    
    .products-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .product-item {
      padding: 15px;
      margin-bottom: 10px;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
    
    .product-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 5px;
    }
    
    .product-info {
      color: #666;
      font-size: 14px;
    }
    
    .quantity-badge {
      display: inline-block;
      padding: 5px 10px;
      background: #4CAF50;
      color: white;
      border-radius: 15px;
      font-weight: bold;
      margin-top: 5px;
    }
    
    .quantity-badge.low {
      background: #f44336;
    }
    
    .scanner-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      z-index: 20;
      display: none;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .scanner-loading.show {
      display: block;
    }
    
    .scanner-loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>–£—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</h1>
    </div>
    
    <button class="btn" onclick="openSellModal()">–ü–†–û–î–ê–ñ–ê (–°–ö–ê–ù–ò–†–û–í–ê–¢–¨)</button>
    <button class="btn btn-secondary" onclick="openReceiveModal()">–ü–†–ò–ù–Ø–¢–¨ –¢–û–í–ê–†</button>
    <button class="btn btn-list" onclick="openAddProductModal()">–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</button>
    <button class="btn btn-list" onclick="openProductsList()">–°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í</button>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–¥–∞–∂–∏ -->
  <div id="sellModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeSellModal()">√ó</button>
      <div class="modal-header">–ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–≤–∞—Ä–∞</div>
      <div id="sellMessage"></div>
      <div class="scanner-container">
        <video id="scanner" autoplay playsinline muted></video>
        <canvas id="scannerCanvas" style="display: none;"></canvas>
        <div class="scanner-overlay"></div>
        <div id="scannerLoading" class="scanner-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä—ã</div>
      </div>
      <div id="sellProductInfo"></div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–µ–º–∞ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="receiveModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeReceiveModal()">√ó</button>
      <div class="modal-header">–ü—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä</div>
      <div id="receiveMessage"></div>
      <div class="scanner-container">
        <video id="receiveScanner" autoplay playsinline muted></video>
        <canvas id="receiveScannerCanvas" style="display: none;"></canvas>
        <div class="scanner-overlay"></div>
        <div id="receiveScannerLoading" class="scanner-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä—ã</div>
      </div>
      <div id="receiveProductInfo"></div>
      <div class="form-group" id="quantityInputGroup" style="display: none;">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
        <input type="number" id="receiveQuantity" min="1" value="1">
        <button class="btn" onclick="confirmReceive()" style="margin-top: 10px;">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeAddProductModal()">√ó</button>
      <div class="modal-header">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</div>
      <div id="addProductMessage"></div>
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</label>
        <input type="text" id="productName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
      </div>
      <div class="form-group">
        <label>–®—Ç—Ä–∏—Ö-–∫–æ–¥:</label>
        <input type="text" id="productBarcode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ">
        <button class="btn btn-secondary" onclick="scanBarcodeForAdd()" style="margin-top: 10px;">–°–ö–ê–ù–ò–†–û–í–ê–¢–¨</button>
      </div>
      <div class="form-group">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
        <input type="number" id="productQuantity" min="0" value="0">
      </div>
      <button class="btn" onclick="addProduct()">–î–û–ë–ê–í–ò–¢–¨ –ù–ê –°–ö–õ–ê–î</button>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div id="scanBarcodeModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeScanBarcodeModal()">√ó</button>
      <div class="modal-header">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞</div>
      <div class="scanner-container">
        <video id="barcodeScanner" autoplay playsinline muted></video>
        <canvas id="barcodeScannerCanvas" style="display: none;"></canvas>
        <div class="scanner-overlay"></div>
        <div id="barcodeScannerLoading" class="scanner-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä—ã</div>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div id="productsListModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeProductsList()">√ó</button>
      <div class="modal-header">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</div>
      <div id="productsList" class="products-list"></div>
    </div>
  </div>
  
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
  <script src="/app.js"></script>
  <script>
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
        .catch(err => console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', err));
    }
  </script>
  
  <!-- –ü–∞–Ω–µ–ª—å –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
  <div id="debugLogs"></div>
  <button id="toggleLogs" onclick="toggleDebugLogs()">üìã –õ–æ–≥–∏</button>
  
  <script>
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    const debugLogsEl = document.getElementById('debugLogs');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    const originalInfo = console.info;
    
    let logsVisible = false;
    const maxLogs = 50;
    let logCount = 0;
    
    function addLogToScreen(message, type = 'info') {
      if (!debugLogsEl) return;
      
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugLogsEl.appendChild(entry);
      
      logCount++;
      if (logCount > maxLogs) {
        debugLogsEl.removeChild(debugLogsEl.firstChild);
        logCount--;
      }
      
      // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
      debugLogsEl.scrollTop = debugLogsEl.scrollHeight;
    }
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      addLogToScreen(args.join(' '), 'info');
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      addLogToScreen(args.join(' '), 'error');
    };
    
    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addLogToScreen(args.join(' '), 'warning');
    };
    
    console.info = function(...args) {
      originalInfo.apply(console, args);
      addLogToScreen(args.join(' '), 'info');
    };
    
    function toggleDebugLogs() {
      logsVisible = !logsVisible;
      if (logsVisible) {
        debugLogsEl.classList.add('show');
        document.getElementById('toggleLogs').textContent = '‚ùå –ó–∞–∫—Ä—ã—Ç—å';
      } else {
        debugLogsEl.classList.remove('show');
        document.getElementById('toggleLogs').textContent = 'üìã –õ–æ–≥–∏';
      }
    }
    
    function copyLogsToClipboard() {
      const logEntries = debugLogsEl.querySelectorAll('.log-entry');
      let logsText = '=== –õ–û–ì–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===\n';
      logsText += `–í—Ä–µ–º—è: ${new Date().toLocaleString()}\n`;
      logsText += `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${logEntries.length}\n\n`;
      
      logEntries.forEach((entry, index) => {
        const type = entry.className.includes('error') ? 'ERROR' : 
                     entry.className.includes('warning') ? 'WARN' : 
                     entry.className.includes('success') ? 'SUCCESS' : 'INFO';
        logsText += `${index + 1}. [${type}] ${entry.textContent}\n`;
      });
      
      // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(logsText).then(() => {
          showCopySuccess();
        }).catch((err) => {
          // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          fallbackCopyTextToClipboard(logsText);
        });
      } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        fallbackCopyTextToClipboard(logsText);
      }
    }
    
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showCopySuccess();
        } else {
          showCopyError();
        }
      } catch (err) {
        showCopyError();
      }
      
      document.body.removeChild(textArea);
    }
    
    function showCopySuccess() {
      const btn = document.getElementById('copyLogs');
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      btn.style.background = '#4CAF50';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#2196F3';
      }, 2000);
    }
    
    function showCopyError() {
      const btn = document.getElementById('copyLogs');
      const originalText = btn.textContent;
      btn.textContent = '‚ùå –û—à–∏–±–∫–∞';
      btn.style.background = '#f44336';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#2196F3';
      }, 2000);
    }
    
    function copyLogsToClipboard() {
      const logEntries = debugLogsEl.querySelectorAll('.log-entry');
      let logsText = '=== –õ–û–ì–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===\n';
      logsText += `–í—Ä–µ–º—è: ${new Date().toLocaleString()}\n`;
      logsText += `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${logEntries.length}\n\n`;
      
      logEntries.forEach((entry, index) => {
        const type = entry.className.includes('error') ? 'ERROR' : 
                     entry.className.includes('warning') ? 'WARN' : 
                     entry.className.includes('success') ? 'SUCCESS' : 'INFO';
        logsText += `${index + 1}. [${type}] ${entry.textContent}\n`;
      });
      
      // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(logsText).then(() => {
          showCopySuccess();
        }).catch((err) => {
          // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          fallbackCopyTextToClipboard(logsText);
        });
      } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        fallbackCopyTextToClipboard(logsText);
      }
    }
    
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showCopySuccess();
        } else {
          showCopyError();
        }
      } catch (err) {
        showCopyError();
      }
      
      document.body.removeChild(textArea);
    }
    
    function showCopySuccess() {
      const btn = document.getElementById('copyLogs');
      const originalText = btn.textContent;
      btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      btn.style.background = '#4CAF50';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#2196F3';
      }, 2000);
    }
    
    function showCopyError() {
      const btn = document.getElementById('copyLogs');
      const originalText = btn.textContent;
      btn.textContent = '‚ùå –û—à–∏–±–∫–∞';
      btn.style.background = '#f44336';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#2196F3';
      }, 2000);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    window.addEventListener('error', (e) => {
      addLogToScreen(`–û–®–ò–ë–ö–ê: ${e.message}`, 'error');
      if (!logsVisible) {
        toggleDebugLogs();
      }
    });
  </script>
</body>
</html>

