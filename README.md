# Учет товаров - MVP

Простое PWA приложение для учета товаров в продуктовом магазине с поддержкой сканирования штрих-кодов.

## Технические требования

- Работает в Chrome на Android
- Поддержка камеры через getUserMedia
- Защита от запуска в Telegram WebView
- Использует библиотеку html5-qrcode для сканирования EAN-13
- Backend на Node.js/Express
- Готово к деплою на Railway

## Структура проекта

```
elpos/
├── backend/           # Backend сервис
│   ├── server.js      # Backend сервер (Express API)
│   ├── package.json   # Зависимости backend
│   └── data/          # Данные (создается автоматически)
│       └── products.json
├── frontend/          # Frontend сервис
│   ├── server.js      # Frontend сервер (статический)
│   ├── package.json   # Зависимости frontend
│   ├── index.html     # Основная разметка
│   ├── app.js         # Логика приложения (API клиент)
│   ├── style.css      # Стили (темная тема)
│   └── manifest.json  # PWA манифест
├── railway.toml       # Конфигурация Railway
├── .gitignore         # Игнорируемые файлы
├── README.md          # Документация
├── DEPLOY_RAILWAY.md  # Инструкции по деплою на Railway (два сервиса)
├── DEPLOY.md          # Общие инструкции по деплою
└── QUICKSTART.md      # Быстрый старт
```

## Функционал

1. **Продажа товара**
   - Сканирование штрих-кода
   - Автоматическое уменьшение остатка на 1
   - Отображение названия и нового остатка

2. **Прием товара**
   - Сканирование штрих-кода
   - Ввод количества
   - Увеличение остатка

3. **Управление складом**
   - Просмотр всех товаров
   - Добавление нового товара
   - Сканирование штрих-кода при добавлении

## API Endpoints

- `GET /api/products` - Получить все товары
- `GET /api/products/:id` - Получить товар по ID
- `GET /api/products/barcode/:barcode` - Найти товар по штрих-коду
- `POST /api/products` - Создать товар
- `PUT /api/products/:id` - Обновить товар
- `DELETE /api/products/:id` - Удалить товар
- `POST /api/products/:id/sell` - Продать товар (уменьшить на 1)
- `POST /api/products/:id/receive` - Принять товар (увеличить количество)

## Хранение данных

Данные хранятся в файле `data/products.json` на сервере в формате JSON:
```json
[
  {
    "id": "1234567890",
    "name": "Товар",
    "barcode": "1234567890123",
    "quantity": 10
  }
]
```

## Локальная разработка

### Установка зависимостей

```bash
npm install
```

### Запуск сервера

```bash
npm start
```

Сервер запустится на `http://localhost:3000`

### Для тестирования на Android

1. Убедитесь, что ваш компьютер и телефон в одной сети Wi-Fi
2. Найдите IP-адрес компьютера:
```bash
# macOS/Linux
ifconfig | grep "inet "

# Windows
ipconfig
```

3. Запустите сервер (он уже слушает на всех интерфейсах)
4. Откройте на телефоне: `http://ВАШ_IP:3000`

**ВАЖНО**: Для работы камеры на реальном устройстве нужен HTTPS. Используйте:
- ngrok для туннелирования: `ngrok http 3000`
- Или разверните на Railway (автоматический HTTPS)

## Деплой на Railway

Проект состоит из двух сервисов (frontend и backend), которые нужно деплоить отдельно.

**Подробные инструкции в файле [DEPLOY_RAILWAY.md](./DEPLOY_RAILWAY.md)**

Кратко:
1. Создайте два сервиса в Railway:
   - Backend сервис (Root Directory: `backend`)
   - Frontend сервис (Root Directory: `frontend`)
2. Настройте переменные окружения:
   - Backend: `FRONTEND_URL` = URL frontend сервиса
   - Frontend: `API_URL` = URL backend сервиса
3. Railway автоматически задеплоит оба сервиса

## Проверка работы камеры

1. Откройте приложение в Chrome на Android (через HTTPS)
2. Разрешите доступ к камере при запросе
3. Наведите камеру на штрих-код EAN-13
4. Приложение должно автоматически распознать код

## Возможные проблемы и решения

### 1. Черный экран камеры

**Причины:**
- Камера используется другим приложением
- Неправильные разрешения
- Проблемы с getUserMedia

**Решения:**
- Закройте другие приложения, использующие камеру
- Проверьте разрешения браузера в настройках Android
- Перезагрузите страницу
- Используйте `facingMode: "environment"` (уже реализовано)

### 2. Камера не запускается

**Причины:**
- Сайт открыт не через HTTPS (кроме localhost)
- Блокировка в настройках браузера
- Telegram WebView (должно быть заблокировано)

**Решения:**
- Используйте HTTPS или localhost
- Проверьте настройки Chrome: Настройки → Конфиденциальность → Камера
- Откройте сайт в обычном браузере, не в Telegram

### 3. Штрих-код не распознается

**Причины:**
- Плохое освещение
- Неправильный формат (нужен EAN-13)
- Камера не в фокусе

**Решения:**
- Улучшите освещение
- Держите камеру на расстоянии 10-20 см от штрих-кода
- Убедитесь, что штрих-код четкий и не поврежден

### 4. API не работает

**Причины:**
- Сервер не запущен
- Неправильный URL
- Проблемы с CORS

**Решения:**
- Проверьте, что сервер запущен (логи в консоли)
- Убедитесь, что используется правильный URL
- CORS уже настроен в server.js

### 5. Приложение не работает в Telegram

**Это нормально!** Приложение специально блокирует работу в Telegram WebView, так как камера там не работает. Откройте сайт в обычном браузере Chrome.

## Технические детали

### Проверка Telegram WebView
```javascript
function isTelegramWebView() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    return /Telegram/i.test(userAgent);
}
```

### Настройки камеры
- `facingMode: "environment"` - задняя камера
- `fps: 10` - частота кадров
- Поддержка EAN-13 через html5-qrcode

### PWA
- Манифест настроен для установки как приложение
- Работает в standalone режиме
- Темная тема для лучшей работы камеры

### Backend
- Express.js сервер
- RESTful API
- Хранение данных в JSON файле
- CORS настроен для работы с фронтендом

## Дальнейшее развитие

- Экспорт/импорт данных
- История операций
- Поиск товаров
- Статистика продаж
- Миграция на базу данных (PostgreSQL, MongoDB)
- Аутентификация пользователей
- Мультипользовательский режим
