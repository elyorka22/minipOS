# Настройка PostgreSQL в Railway

## Автоматическое подключение

Railway **может** автоматически подключить PostgreSQL, но это зависит от того, как вы добавляете сервисы:

### Вариант 1: Автоматическое подключение (если сервисы в одном проекте)

Если PostgreSQL и ваше приложение находятся в **одном проекте Railway**, Railway может автоматически:
1. Создать переменную `DATABASE_URL` в вашем приложении
2. Связать её с PostgreSQL сервисом

**Но это не всегда происходит автоматически!**

### Вариант 2: Ручное подключение (рекомендуется)

Даже если Railway не подключил автоматически, вы можете сделать это вручную:

## Пошаговая инструкция

### Шаг 1: Добавить PostgreSQL

1. В Railway Dashboard откройте ваш проект
2. Нажмите **"+ New"** → **"Database"** → **"Add PostgreSQL"**
3. Railway создаст PostgreSQL сервис

### Шаг 2: Проверить, добавился ли DATABASE_URL автоматически

1. Откройте ваш **приложение** (не PostgreSQL)
2. Перейдите в **"Variables"**
3. Проверьте, есть ли переменная `DATABASE_URL`

### Шаг 3: Если DATABASE_URL НЕТ - добавить вручную

1. В вашем приложении нажмите **"Variables"**
2. Нажмите **"+ New Variable"**
3. В поле **"Name"** введите: `DATABASE_URL`
4. В поле **"Value"** нажмите на иконку **"Reference"** (или выберите из списка)
5. Выберите ваш **PostgreSQL сервис**
6. **ВАЖНО:** Выберите **`DATABASE_URL`** (НЕ `DATABASE_PUBLIC_URL`)
   - `DATABASE_URL` - внутренний URL (рекомендуется, быстрее и безопаснее)
   - `DATABASE_PUBLIC_URL` - публичный URL (только если нужен внешний доступ)
7. Нажмите **"Add"**

**Примечание:** Приложение поддерживает оба варианта, но `DATABASE_URL` имеет приоритет.

### Шаг 4: Проверка

После добавления `DATABASE_URL`:
1. Railway автоматически **перезапустит** ваше приложение
2. Проверьте логи - должно быть: `"Используется PostgreSQL"`
3. Проверьте health endpoint: `https://your-app.railway.app/health`
4. Должно показать: `"database": { "status": "connected" }`

## Как проверить, что подключено

### 1. Проверьте переменные окружения

В Railway Dashboard → ваше приложение → Variables:
- Должна быть переменная `DATABASE_URL` (или `DATABASE_PUBLIC_URL`)
- Значение должно начинаться с `postgresql://`
- **Рекомендуется использовать `DATABASE_URL`** (внутренний, быстрее)

### 2. Проверьте логи

После перезапуска в логах должно быть:
```
Используется PostgreSQL
Подключение к PostgreSQL установлено
Таблица products создана/проверена
✓ Таблица products существует в схеме public
База данных инициализирована успешно
```

### 3. Проверьте health endpoint

Откройте: `https://your-app.railway.app/health`

Должно вернуть:
```json
{
  "status": "ok",
  "database": {
    "status": "connected",
    "tableCount": 0,
    "hasDatabaseUrl": true
  }
}
```

### 4. Проверьте диагностику

Откройте: `https://your-app.railway.app/api/debug/db`

Должно показать:
```json
{
  "initialized": true,
  "tables": ["products"],
  "productsCount": 0,
  "productsColumns": [...],
  "databaseUrl": "установлен"
}
```

## Важно!

- **Переменная `DATABASE_URL` должна быть в вашем ПРИЛОЖЕНИИ**, а не только в PostgreSQL сервисе
- После добавления переменной Railway автоматически перезапустит приложение
- Таблица `products` создастся автоматически при первом запуске
- Если таблицы нет - проверьте логи на ошибки

## Troubleshooting

### DATABASE_URL не добавляется автоматически

Это нормально! Добавьте вручную через Reference (см. Шаг 3 выше).

### Приложение не подключается к БД

1. Проверьте, что `DATABASE_URL` установлен в Variables вашего приложения
2. Проверьте логи на ошибки подключения
3. Убедитесь, что PostgreSQL сервис запущен

### Таблицы не создаются

1. Проверьте логи - должны быть сообщения об инициализации
2. Проверьте права доступа пользователя БД
3. Попробуйте создать таблицу вручную через Query в Railway

